pipeline {
    agent any

    tools {
        jdk 'java17'
        maven 'Maven3.9.11'
    }

    environment {
        imageName           = 'sonarqube1'
        registryCredentials = 'nexus-docker-cred'
        registry            = 'https://v2deploy.rtwohealthcare.com'
        dockerImage = ''
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Maven Build + Tests') {
            steps {
                sh '''
                    cd Additions
                    mvn clean verify
                '''
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh '''
                        cd Additions
                        mvn sonar:sonar \
                          -Dsonar.projectKey=Javaproject \
                          -Dsonar.projectName=Javaproject
                    '''
                }
            }
        }

        stage('Quality Gate (Coverage < 80%)') {
            steps {
                script {
                    timeout(time: 3, unit: 'MINUTES') {
                        def qg = waitForQualityGate()

                        if (qg.status != 'OK') {
                            emailext(
                                to: 'monish.reddy@invensis.net',
                                subject: "❌ Code Coverage < 80% | ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                                mimeType: 'text/html',
                                body: """
                                <html>
                                  <body>
                                    <h2 style="color:red;">Quality Gate Failed ❌</h2>
                                    <p><b>Status:</b> ${qg.status}</p>
                                    <p><b>Coverage Threshold:</b> 80%</p>
                                    <p>
                                      <a href="${env.BUILD_URL}">
                                        View Jenkins Build
                                      </a>
                                    </p>
                                  </body>
                                </html>
                                """
                            )
                            error "Stopping pipeline due to Quality Gate failure"
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dockerImage = docker.build(imageName)
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry(registry, registryCredentials) {
                        dockerImage.push()
                    }
                }
            }
        }
    }
}
