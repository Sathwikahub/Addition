pipeline {
    agent any

    tools {
        jdk "java17"
        maven "Maven3.9.11"
    }

    environment {
        SONAR_SERVER = "Sonar_Maven"
        SONAR_PROJECT_KEY = "Javaproject"
        REGISTRY_URL = "https://v2deploy.rtwohealthcare.com"
        REGISTRY_CRED = "nexus-docker-cred"
        IMAGE_NAME = "sonarqube1"
    }

    stages {

        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Build + Test + Coverage') {
            steps {
                sh "cd Additions && mvn clean verify"
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONAR_SERVER}") {
                    withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
                        sh """
                          cd Additions
                          mvn sonar:sonar \
                            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                            -Dsonar.branch.name=${env.BRANCH_NAME} \
                            -Dsonar.token=${SONAR_TOKEN}
                        """
                    }
                }
            }
        }

        stage('Quality Gate Check') {
            steps {
                script {
                    timeout(time: 2, unit: 'MINUTES') {
                        def qg = waitForQualityGate()
                        env.QG_STATUS = qg.status

                        def coverageMetric = qg.conditions.find {
                            it.metricKey == 'coverage'
                        }

                        env.COVERAGE = coverageMetric?.actualValue ?: "N/A"
                        env.COVERAGE_STATUS = coverageMetric?.status ?: "UNKNOWN"

                        if (qg.status != 'OK') {
                            error "Quality Gate Failed"
                        }
                    }
                }
            }
        }
    }

    post {
        failure {
            script {

                /* EMAIL ONLY FOR COVERAGE FAILURE */
                if (env.COVERAGE_STATUS == 'ERROR') {

                    def sonarDashboard =
                        "https://v2code.rtwohealthcare.com/dashboard?id=${SONAR_PROJECT_KEY}&branch=${env.BRANCH_NAME}"

                    emailext(
                        to: "monish.reddy@invensis.net",
                        subject: "‚ùå Code Coverage Failed | ${JOB_NAME} #${BUILD_NUMBER}",
                        mimeType: 'text/html',
                        body: """
                        <html>
                        <body style="font-family: Arial;">
                            <h2 style="color:red;">Code Coverage Quality Gate Failed</h2>

                            <table border="1" cellpadding="8">
                                <tr><th align="left">Project</th><td>${SONAR_PROJECT_KEY}</td></tr>
                                <tr><th align="left">Branch</th><td>${env.BRANCH_NAME}</td></tr>
                                <tr><th align="left">Coverage</th>
                                    <td style="color:red;"><b>${env.COVERAGE}%</b></td></tr>
                                <tr><th align="left">Required</th><td>‚â• Quality Gate Threshold</td></tr>
                                <tr><th align="left">Quality Gate</th><td>${env.QG_STATUS}</td></tr>
                            </table>

                            <br/>
                            <p>
                                üîó <a href="${sonarDashboard}">
                                View SonarQube Dashboard</a>
                            </p>

                            <p>
                                üîó <a href="${BUILD_URL}">
                                View Jenkins Build</a>
                            </p>
                        </body>
                        </html>
                        """
                    )
                }
            }
        }
    }
}
