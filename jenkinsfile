pipeline {
    agent any

    tools {
        jdk 'java17'
        maven 'Maven3.9.11'
    }

    environment {
        SONAR_HOST_URL = 'https://v2code.rtwohealthcare.com'

        imageName           = 'sonarqube1'
        registryCredentials = 'nexus-docker-cred'
        registry            = 'https://v2deploy.rtwohealthcare.com'

        dockerImage = ''
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Maven Build + Tests') {
            steps {
                sh '''
                    cd Additions
                    mvn -B clean verify
                '''
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh '''
                        cd Additions
                        mvn sonar:sonar \
                          -Dsonar.projectKey=Javaproject \
                          -Dsonar.projectName=Javaproject
                    '''
                }
            }
        }

        stage('Quality Gate Check (Mail Only)') {
            steps {
                script {
                    catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE') {

                        timeout(time: 2, unit: 'MINUTES') {
                            def qg = waitForQualityGate()

                            if (qg.status != 'OK') {

                                emailext(
                                    to: 'monish.reddy@invensis.net',
                                    subject: "⚠️ Code Coverage Below 80% - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                                    mimeType: 'text/html',
                                    body: """
                                    <html>
                                      <body>
                                        <h2 style="color:orange;">Code Coverage Warning</h2>
                                        <p><b>Quality Gate Status:</b> ${qg.status}</p>
                                        <p>Pipeline continues. Please improve coverage.</p>

                                        <p>
                                          <a href="${SONAR_HOST_URL}">
                                            View SonarQube Report
                                          </a>
                                        </p>
                                      </body>
                                    </html>
                                    """
                                )
                            }
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dockerImage = docker.build(imageName)
                }
            }
        }

        stage('Push to Docker Registry') {
            steps {
                script {
                    docker.withRegistry(registry, registryCredentials) {
                        dockerImage.push()
                    }
                }
            }
        }
    }
}
