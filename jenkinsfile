pipeline {
    agent any

    tools {
        jdk "java17"
        maven "Maven3.9.11"
    }

    environment {
        SONAR_HOST_URL = "http://10.80.5.127:9070"
        SONAR_PROJECT_KEY = "Javaproject"
        COVERAGE_THRESHOLD = "80"

        DOCKER_REGISTRY_URL = "v2deploy.rtwohealthcare.com"
        IMAGE_NAME = "test-v2"
        IMAGE_TAG = "v${BUILD_NUMBER}"
    }

    stages {

        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Build + Tests + JaCoCo') {
            steps {
                sh '''
                  cd Additions
                  mvn clean verify jacoco:report
                '''
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh '''
                      cd Additions
                      mvn sonar:sonar \
                        -Dsonar.projectKey=${SONAR_PROJECT_KEY}
                    '''
                }
            }
        }

        stage('Quality Gate (Coverage Check)') {
            steps {
                script {
                    timeout(time: 2, unit: 'MINUTES') {
                        def qg = waitForQualityGate(abortPipeline: false)

                        if (qg.status != 'OK') {

                            def sonarLink = "${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}"

                            emailext(
                                to: 'monish.reddy@invensis.net',
                                subject: "‚ùå Coverage Failed (<80%) | ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                                mimeType: 'text/html',
                                body: """
                                <html>
                                <body>
                                    <h2 style="color:red;">Quality Gate Failed</h2>

                                    <table border="1" cellpadding="8">
                                        <tr><th>Project</th><td>${SONAR_PROJECT_KEY}</td></tr>
                                        <tr><th>Threshold</th><td>${COVERAGE_THRESHOLD}%</td></tr>
                                        <tr><th>Status</th><td style="color:red;">FAILED</td></tr>
                                        <tr><th>Sonar Dashboard</th>
                                            <td>
                                              <a href="${sonarLink}">${sonarLink}</a>
                                            </td>
                                        </tr>
                                        <tr><th>Build</th>
                                            <td>
                                              <a href="${env.BUILD_URL}">View Build</a>
                                            </td>
                                        </tr>
                                    </table>

                                    <p><b>Reason:</b> Code coverage is below ${COVERAGE_THRESHOLD}%</p>
                                </body>
                                </html>
                                """
                            )

                            error "Stopping pipeline due to coverage failure"
                        }
                    }
                }
            }
        }

        stage('Docker Build') {
            steps {
                sh '''
                  cd Additions
                  docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                  docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${DOCKER_REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                '''
            }
        }

        stage('Docker Push') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'nexus-docker-cred',
                    usernameVariable: 'USER',
                    passwordVariable: 'PASS'
                )]) {
                    sh '''
                      echo "$PASS" | docker login ${DOCKER_REGISTRY_URL} -u "$USER" --password-stdin
                      docker push ${DOCKER_REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                      docker logout ${DOCKER_REGISTRY_URL}
                    '''
                }
            }
        }
    }
}
