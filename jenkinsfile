pipeline {
    agent any

    tools {
        jdk 'java17'
        maven 'Maven3.9.11'
    }

    environment {
        SONAR_HOST_URL = 'https://v2code.rtwohealthcare.com'

        imageName           = 'sonarqube1'
        registryCredentials = 'nexus-docker-cred'
        registry            = 'https://v2deploy.rtwohealthcare.com'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Maven Build + Tests') {
            steps {
                sh '''
                    cd Additions
                    mvn -B clean verify
                '''
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
                        sh '''
                            cd Additions
                            mvn sonar:sonar \
                              -Dsonar.projectKey=Javaproject \
                              -Dsonar.projectName=Javaproject \
                              -Dsonar.token=${SONAR_TOKEN}
                        '''
                    }
                }
            }
        }

        stage('Quality Gate Check (Mail Only)') {
            steps {
                script {
                    timeout(time: 2, unit: 'MINUTES') {

                        def qg = waitForQualityGate()

                        if (qg.status != 'OK') {

                            // ⚠️ Mark UNSTABLE, NOT FAILED
                            currentBuild.result = 'UNSTABLE'

                            emailext(
                                to: 'monish.reddy@invensis.net',
                                subject: "⚠️ SonarQube Quality Gate Failed - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                                mimeType: 'text/html',
                                body: """
                                <html>
                                  <body style="font-family: Arial;">
                                    <h2 style="color:red;">❌ SonarQube Quality Gate Failed</h2>

                                    <p><b>Status:</b> ${qg.status}</p>
                                    <p><b>Reason:</b> Code coverage below threshold</p>

                                    <table border="1" cellpadding="8">
                                      <tr>
                                        <th>Job Name</th>
                                        <td>${env.JOB_NAME}</td>
                                      </tr>
                                      <tr>
                                        <th>Build Number</th>
                                        <td>${env.BUILD_NUMBER}</td>
                                      </tr>
                                      <tr>
                                        <th>Sonar Dashboard</th>
                                        <td>
                                          <a href="${SONAR_HOST_URL}/dashboard?id=Javaproject">
                                            View Report
                                          </a>
                                        </td>
                                      </tr>
                                    </table>

                                    <br/>
                                    <p>✔️ Pipeline continued successfully.</p>
                                  </body>
                                </html>
                                """
                            )
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dockerImage = docker.build(imageName)
                }
            }
        }

        stage('Push to Docker Registry') {
            steps {
                script {
                    docker.withRegistry(registry, registryCredentials) {
                        dockerImage.push()
                    }
                }
            }
        }
    }
}
